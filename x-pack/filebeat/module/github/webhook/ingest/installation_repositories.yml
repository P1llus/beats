description: Pipeline to parse installation_repositories github wehhooks
processors:
- append:
    field: event.type
    value:
    - info
    - installation
- append:
    field: event.type
    value: creation
    if: ctx.github?.action == 'added'
- append:
    field: event.type
    value: deletion
    if: ctx.github?.action == 'removed'
- set:
    field: event.outcome
    value: success
- set:
    field: event.kind
    value: event
- set:
    field: event.action
    value: installation_repositories-{{github.action}}
- foreach:
    field: github.repositories_added
    processor:
      append:
        field: github.related.repository.name
        value: '{{_ingest._value.full_name}}'
    if: ctx.github?.action == 'added'
- foreach:
    field: github.repositories_added
    processor:
      append:
        field: github.related.repository.id
        value: '{{_ingest._value.id}}'
    if: ctx.github?.action == 'added'
- foreach:
    field: github.repositories_removed
    processor:
      append:
        field: github.related.repository.name
        value: '{{_ingest._value.full_name}}'
    if: ctx.github?.action == 'removed'
- foreach:
    field: github.repositories_removed
    processor:
      append:
        field: github.related.repository.id
        value: '{{_ingest._value.id}}'
    if: ctx.github?.action == 'removed'
- script:
    lang: painless
    source: ctx.github.related.repository.count = (ctx.github.repositories_added).length()
    if: ctx.github?.action == 'added'
- script:
    lang: painless
    source: ctx.github.related.repository.count = (ctx.github.repositories_removed).length()
    if: ctx.github?.action == 'removed'
- remove:
    field:
    - github.repositories_removed
    - github.repositories_added
    - github.repositories_selection
    - github.organization
    - github.installation.account
    - github.sender
    ignore_missing: true
on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'
