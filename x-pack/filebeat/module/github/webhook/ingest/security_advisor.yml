description: Pipeline to parse security_advisory github wehhooks
processors:
- append:
    field: event.type
    value: creation
    if: ctx.github?.action == 'published'
- append:
    field: event.type
    value: change
    if: "['edited', 'closed', 'reopened'].contains(ctx.github?.action)"
- remove:
    field: event.kind
    ignore_missing: true
- set:
    field: event.kind
    value: alert
- set:
    field: event.action
    value: security_advisor-{{github.action}}
- rename:
    field: github.security_advisory
    target_field: _temp_.security_advisory
    ignore_missing: true
- foreach:
    field: _temp_.security_advisory.identifiers
    processor:
      append:
        field: github.security_advisory.identifiers
        value: "{{_ingest._value.value}}"
    if: ctx._temp_?.security_advisory?.identifiers != null
- foreach:
    field: _temp_.security_advisory.references
    processor:
      append:
        field: github.security_advisory.references
        value: "{{_ingest._value.url}}"
    if: ctx._temp_?.security_advisory?.references != null
- rename:
    field: _temp_.security_advisory.vulnerabilities
    target_field: github.security_advisory.vulnerabilities
    ignore_missing: true
- remove:
    field:
    - _temp_
    ignore_missing: true
on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'
