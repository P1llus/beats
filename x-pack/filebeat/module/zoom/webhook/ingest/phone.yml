description: Pipeline for parsing Zoom phone webhooks
processors:
- append:
    field: event.type
    value: info
- append:
    field: event.type
    value: creation
    if: "['phone.caller_ringing', 'phone.callee_ringing'].contains(ctx?.event?.action)"
- append:
    field: event.type
    value: start
    if: "['phone.callee_answered', 'phone.caller_connected'].contains(ctx?.event?.action)"
- append:
    field: event.type
    value: end
    if: "['phone.callee_missed', 'phone.callee_ended', 'phone.caller_ended'].contains(ctx?.event?.action)"
- rename:
    field: zoom.object
    target_field: zoom.phone
    ignore_missing: true
- append:
    field: related.user
    value: "{{zoom.phone.callee.user_id}}"
    if: "ctx?.zoom?.phone?.callee?.user_id != null"
- append:
    field: related.user
    value: "{{zoom.phone.callee_user_id}}"
    if: "ctx?.zoom?.phone?.callee_user_id != null"
- append:
    field: related.user
    value: "{{zoom.phone.caller.user_id}}"
    if: "ctx?.zoom?.phone?.caller?.user_id != null"
on_failure:
- set:
    field: error.message
    value: '{{ _ingest.on_failure_message }}'
